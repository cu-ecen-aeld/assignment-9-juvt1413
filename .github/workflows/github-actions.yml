name: assignment-test
on:
    push:
        tags-ignore:
            - '*'
        branches:
            - '*'
jobs:
    full-test:
        container: cuaesd/aesd-autotest:24-assignment7-buildroot
        runs-on: self-hosted
        timeout-minutes: 120
        steps:
          - uses: actions/checkout@v2
          - name: Checkout submodules
            run: |
              # Configure git for better network handling
              git config --global http.postBuffer 524288000
              git config --global http.lowSpeedLimit 1000
              git config --global http.lowSpeedTime 300
              
              # Initialize and sync submodules
              git submodule init
              git submodule sync
              
              # Get expected buildroot commit
              BUILDROOT_COMMIT=$(git ls-tree HEAD buildroot | awk '{print $3}')
              echo "Expected buildroot commit: $BUILDROOT_COMMIT"
              
              # Try standard update first
              if git submodule update --init --recursive; then
                echo "Submodule update succeeded!"
                exit 0
              fi
              
              # Workaround: If standard update fails, manually handle buildroot
              echo "Standard update failed, using workaround for buildroot..."
              
              # Update assignment-autotest first (this usually works)
              git submodule update --init assignment-autotest || true
              
              # For buildroot, manually clone and checkout if needed
              if [ ! -d buildroot/.git ] && [ ! -f buildroot/.git ]; then
                echo "Cloning buildroot manually..."
                rm -rf buildroot
                git clone https://git.busybox.net/buildroot/ buildroot
                cd buildroot
                git checkout $BUILDROOT_COMMIT || {
                  echo "Failed to checkout commit, trying to fetch it..."
                  git fetch origin $BUILDROOT_COMMIT || git fetch origin
                  git checkout $BUILDROOT_COMMIT || git checkout -b temp-branch $BUILDROOT_COMMIT || true
                }
                cd ..
                # Mark it as a submodule
                git config submodule.buildroot.url https://git.busybox.net/buildroot/
                git config submodule.buildroot.path buildroot
              elif [ -d buildroot/.git ] || [ -f buildroot/.git ]; then
                echo "Buildroot exists, checking if commit matches..."
                cd buildroot
                CURRENT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "")
                if [ "$CURRENT_COMMIT" != "$BUILDROOT_COMMIT" ]; then
                  echo "Updating buildroot to correct commit..."
                  git fetch origin $BUILDROOT_COMMIT || git fetch origin || true
                  git checkout $BUILDROOT_COMMIT || true
                fi
                cd ..
              fi
              
              # Verify buildroot is at correct commit
              if [ -d buildroot/.git ] || [ -f buildroot/.git ]; then
                cd buildroot
                ACTUAL_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "")
                if [ "$ACTUAL_COMMIT" = "$BUILDROOT_COMMIT" ]; then
                  echo "Buildroot is at correct commit: $BUILDROOT_COMMIT"
                  cd ..
                  exit 0
                else
                  echo "Warning: Buildroot commit mismatch. Expected: $BUILDROOT_COMMIT, Got: $ACTUAL_COMMIT"
                  cd ..
                fi
              fi
              
              echo "Submodule setup completed (with workarounds)"
          - uses: webfactory/ssh-agent@v0.5.3
            with:
                ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          - name: Run full test
            env:
              GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no"
            run: ./full-test.sh
          - name: Cleanup
            if: always()
            run: |
              ssh-add -D
